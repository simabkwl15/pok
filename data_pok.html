<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POK - SiMAB</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
.popup-overlay{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.popup-box{
  background:#fff;
  width:900px;
  border-radius:8px;
  padding:20px;
}

.popup-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

.popup-body{
  display:flex;
  gap:30px;
}

.form-left,
.form-right{
  flex:1;
  display:flex;
  flex-direction:column;
}

.form-left input,
.form-right input,
textarea{
  margin-bottom:10px;
  padding:6px;
}

.popup-footer{
  text-align:right;
  margin-top:15px;
}

.btn-simpan{
  padding:6px 15px;
  background:#2e86de;
  color:white;
  border:none;
  border-radius:4px;
}

.close-btn{
  cursor:pointer;
}
</style>

    
<style>
    
.modal-content.large{
    width:900px;
    max-height:90vh;
    overflow:auto;
}

.modal-body-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:30px;
}

.form-column{
    display:flex;
    flex-direction:column;
    gap:12px;
}

textarea{
    resize:none;
    padding:8px;
    border-radius:8px;
    border:1px solid #cbd5e1;
}


*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Inter',sans-serif;
}

body{
    display:grid;
    grid-template-columns:240px 1fr;
    background:#f8fafc;
    color:#334155;
}

/* SIDEBAR */
.sidebar{
    height:100vh;
    background:#ffffff;
    border-right:1px solid #e5e7eb;
    position:sticky;
    top:0;
}

.sidebar-brand{
    padding:20px;
    background:#e0f2fe;
    color:#0369a1;
    font-weight:600;
    font-size:18px;
    display:flex;
    align-items:center;
    gap:10px;
}

.sidebar ul{
    list-style:none;
    padding:20px 10px;
}

.sidebar ul li{
    padding:10px 14px;
    margin-bottom:6px;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:12px;
    font-size:14px;
    color:#475569;
    transition:0.2s;
}

.sidebar ul li:hover{background:#f1f5f9;}
.sidebar ul li.active{
    background:#e0f2fe;
    color:#0369a1;
    font-weight:600;
}

/* MAIN */
.main{
    display:flex;
    flex-direction:column;
    height:100vh;
}

/* TOPBAR */
.topbar{
    height:60px;
    background:#ffffff;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 30px;
    position:sticky;
    top:0;
    z-index:1000;
}

.topbar-left{
    font-weight:600;
}

.topbar-right{
    display:flex;
    align-items:center;
    gap:18px;
    font-size:14px;
}

.topbar-right i{
    font-size:16px;
    cursor:pointer;
    color:#475569;
    transition:0.2s;
}

.topbar-right i:hover{
    color:#0369a1;
}

.user-info{
    display:flex;
    align-items:center;
    gap:8px;
    font-weight:500;
}

/* CONTENT */
.content{
    padding:30px;
    flex:1;
    display:flex;
    flex-direction:column;
    overflow:hidden;
}

/* FILTER */
.filter-bar{
    background:white;
    padding:18px;
    border-radius:16px;
    border:1px solid #e5e7eb;
    margin-bottom:20px;
    display:flex;
    align-items:center;
    gap:15px;
}

select,input{
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #cbd5e1;
    font-size:14px;
}

button{
    padding:8px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
}

.btn-download{
    background:#38bdf8;
    color:white;
}

/* TABLE */
.table-container{
    flex:1;
    overflow:auto;
    background:white;
    border-radius:16px;
    border:1px solid #e5e7eb;
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
}

thead th{
    position:sticky;
    top:0;
    background:#f1f5f9;
    z-index:10;
}

th,td{
    padding:10px;
    border-bottom:1px solid #e5e7eb;
}

.text-right{text-align:right;}
.text-center{text-align:center;}

.row-pnbp{background:#ffc0cb;}
.row-rm{background:#dcfce7;}

.btn-small{
    padding:5px 10px;
    font-size:12px;
    border-radius:6px;
    margin:2px;
}

.btn-rekam{background:#38bdf8;color:white;}
.btn-detil{background:#6366f1;color:white;}

/* FOOTER */
.footer{
    position:fixed;
    bottom:0;
    left:240px;
    right:0;
    height:45px;
    background:#ffffff;
    border-top:1px solid #e5e7eb;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:13px;
    color:#64748b;
}
</style>
</head>

<body>

<div id="overlayLoading" style="
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.3);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:99999;
    font-size:18px;
    color:#fff;
    display:none;">
    <div>
        <i class="fa-solid fa-spinner fa-spin" style="font-size:32px;"></i>
        <div style="margin-top:10px;">Memuat data...</div>
    </div>
</div>

  
<div class="sidebar">
    <div class="sidebar-brand">
        <i class="fa-solid fa-layer-group"></i>
        <span>SiMAB</span>
    </div>
    <ul>
        <li onclick="goDashboard()">
            <i class="fa-solid fa-gauge"></i>Dashboard
        </li>
        <li class="active" onclick="goPOK()">
            <i class="fa-solid fa-folder-open"></i>POK
        </li>
        <li><i class="fa-solid fa-list-check"></i>Daftar Kegiatan</li>
        <li><i class="fa-solid fa-wallet"></i>Rencana Penarikan Dana</li>
        <li><i class="fa-solid fa-chart-column"></i>Statistik</li>
        <li><i class="fa-solid fa-circle-info"></i>Tentang</li>
    </ul>
</div>

<div class="main">
    <div class="topbar">
        <div class="topbar-left">
            Sistem Monitoring Anggaran Belanja
        </div>

        <div class="topbar-right">
            <i class="fa-regular fa-calendar"></i>
            <i class="fa-solid fa-gear"></i>
            <div class="user-info">
                <i class="fa-regular fa-user"></i>
                <span id="nama"></span>
            </div>
            <i class="fa-solid fa-right-from-bracket" onclick="logout()"></i>
        </div>
    </div>

    <div class="content">

        <div class="filter-bar">
            <strong>Filter POK</strong>
            <select id="filterPok" onchange="applyFilter()">
                <option>Semua</option>
                <option>Umum</option>
                <option>PKN</option>
                <option>PN</option>
                <option>Lelang</option>
                <option>Penilaian</option>
                <option>HI</option>
                <option>KI</option>
            </select>
            <input type="text" id="searchBox" placeholder="Cari kode / uraian..." onkeyup="applyFilter()">
            <button class="btn-download" onclick="downloadExcel()">
                <i class="fa-solid fa-file-excel"></i> 
            </button>
        </div>

        <div class="table-container">
            <table id="tabelPOK">
                <thead>
                    <tr>
                        <th>Kode</th>
                        <th>Uraian</th>
                        <th>Pagu</th>
                        <th>Blokir</th>
                        <th>Realisasi</th>
                        <th>Sisa</th>
                        <th>SD</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>

<div class="footer">
    © KPKNL Denpasar 2026
</div>

<script>
const urlGAS="https://script.google.com/macros/s/AKfycbz9yr8J1iOXDlzJ-nyMK2me_NLEtZUHDH1wtrFHVBaXzi97S-UPCJbSmdBS-EZU_bLiqA/exec";
let allData=[];

const kantor = sessionStorage.getItem("kantor") || "Denpasar"; // default Denpasar
  
function showLoading(){
    document.getElementById("overlayLoading").style.display = "flex";
}

function hideLoading(){
    document.getElementById("overlayLoading").style.display = "none";
}

  
function formatDate(dateStr){
  if(!dateStr) return "";
  const d = new Date(dateStr);
  if(isNaN(d)) return dateStr;

  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');

  return `${yyyy}-${mm}-${dd}`;
}

 function getStatusStyle(status){
  if(!status) return "";

  const s = status.toLowerCase();

  if(s === "rekam data") return "background:#ffc0cb;";          // light pink
  if(s === "terlaksana") return "background:#d9d9d9;";         // abu2
  if(s === "lpt") return "background:#fff3b0;";                // light yellow
  if(s === "terbayar") return "background:#c6efce;";           // light green
  if(s === "selesai") return "background:#cfe2ff;";            // light blue

  return "";
}
 
function formatNumber(num){
    return Number(num||0).toLocaleString("id-ID");
}

function loadData(){
    showLoading();
    fetch(urlGAS + "?kantor=" + encodeURIComponent(kantor))
    .then(res=>res.json())
    .then(data=>{
        allData=data;
        renderTable(allData);
    }).finally(()=>hideLoading());
}




function renderTable(data){
    const tbody=document.querySelector("#tabelPOK tbody");
    tbody.innerHTML="";

    data.forEach(row=>{
        const tr=document.createElement("tr");

        const [kode, uraian, pagu, blokir, realisasi, sisa, sdRaw] = row;
        const sd=(sdRaw||"").toString().trim().toUpperCase();

        if(kode && kode.length>27){
            if(sd==="PNBP") tr.classList.add("row-pnbp");
            if(sd==="RM") tr.classList.add("row-rm");
        }

        tr.innerHTML=`
            <td>${kode||""}</td>
            <td>${uraian||""}</td>
            <td class="text-right">${formatNumber(pagu)}</td>
            <td class="text-right">${formatNumber(blokir)}</td>
            <td class="text-right">${formatNumber(realisasi)}</td>
            <td class="text-right">${formatNumber(sisa)}</td>
            <td class="text-center">${sd}</td>
            <td class="text-center">
                ${kode && kode.length>27 ? `
                    <button class="btn-small btn-rekam" onclick='openRekam(${JSON.stringify(row)})'>Rekam</button>

                    <button class="btn-small btn-detil" onclick="lihatDetail('${kode}')">Detil</button>

                ` : ""}
            </td>
        `;

        tbody.appendChild(tr);
    });
}

function applyFilter(){

    const kategori = document.getElementById("filterPok").value.toLowerCase();
    const search   = document.getElementById("searchBox").value.toLowerCase();

    const filtered = allData.filter(row => {

        const kode    = (row[0] || "").toLowerCase();
        const uraian  = (row[1] || "").toLowerCase();
        const kolomI  = (row[7] || "").toLowerCase(); // ✅ ambil dari kolom I

        const cocokKategori = 
            kategori === "semua" || 
            kolomI === kategori;   // filter exact match kolom I

        const cocokSearch =
            kode.includes(search) ||
            uraian.includes(search);

        return cocokKategori && cocokSearch;
    });

    renderTable(filtered);
}


function downloadExcel(){
    let table=document.getElementById("tabelPOK").outerHTML;
    let blob=new Blob([table],{type:"application/vnd.ms-excel"});
    let url=URL.createObjectURL(blob);
    let a=document.createElement("a");
    a.href=url;
    a.download="Data_POK.xls";
    a.click();
}

function goDashboard(){window.location.href="dashboard.html";}
function goPOK(){window.location.href="data_pok.html";}
function logout(){
    sessionStorage.clear();
    window.location.replace("index.html");
}

    // Ambil nama user dari session
const nama = sessionStorage.getItem("nama");

if (nama) {
    document.getElementById("nama").textContent = nama;
} else {
    // kalau tidak ada session, paksa balik ke login
    window.location.replace("index.html");
}

function generateID(){
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let result = "";
    for(let i=0;i<10;i++){
        result += chars.charAt(Math.floor(Math.random()*chars.length));
    }
    return result;
}
  
function openRekam(row){

    const [kode, uraian, pagu, blokir, realisasi, sisa, sd] = row;

    document.getElementById("popupRekam").style.display="flex";

    const today = new Date();
    document.getElementById("f_tgl").value =
        today.toISOString().split("T")[0];

    document.getElementById("f_id").value = generateID();

    document.getElementById("f_mak").value = kode || "";
    document.getElementById("f_uraian_mak").value = uraian || "";
    document.getElementById("f_pagu").value = formatNumber(pagu);
    document.getElementById("f_blokir").value = formatNumber(blokir);
    document.getElementById("f_realisasi").value = formatNumber(realisasi);
    document.getElementById("f_sisa").value = formatNumber(sisa);
    
    document.getElementById("f_estimasi").value = "";

    const statusBox = document.getElementById("f_sd_status");
    statusBox.value = "";
    statusBox.style.color = "black";
}


function closePopup(){
    document.getElementById("popupRekam").style.display="none";
}

function hitungStatusDana(){

    const pagu = parseFloat(
        document.getElementById("f_pagu").value
        .replace(/\./g,'')
        .replace(/,/g,'')
    ) || 0;

    const blokir = parseFloat(
        document.getElementById("f_blokir").value
        .replace(/\./g,'')
        .replace(/,/g,'')
    ) || 0;

    const realisasi = parseFloat(
        document.getElementById("f_realisasi").value
        .replace(/\./g,'')
        .replace(/,/g,'')
    ) || 0;

    const estimasi = parseFloat(
        document.getElementById("f_estimasi").value
        .replace(/\./g,'')
        .replace(/,/g,'')
    ) || 0;

    const sisa = pagu - blokir - realisasi - estimasi;

    const statusBox = document.getElementById("f_sd_status");

    if(estimasi === 0){
        statusBox.value = "";
        statusBox.style.color = "black";
        return;
    }

    if(sisa >= 0){
        statusBox.value = "Dana Cukup";
        statusBox.style.color = "green";
    }else{
        statusBox.value = "Dana Tidak Cukup";
        statusBox.style.color = "red";
    }
}

  
function parseRupiah(value){
    return parseFloat(value.replace(/\D/g,'')) || 0;
}

async function simpanRekam(){

    const btn = document.querySelector(".btn-simpan");
    btn.disabled = true;
    btn.innerText = "Menyimpan...";

    try{

        const data = new URLSearchParams();
        data.append("id_usulan", document.getElementById("f_id").value.trim());
        data.append("mak", document.getElementById("f_mak").value.trim());
        data.append("uraian", document.getElementById("f_uraian").value.trim());
        data.append("tgl_st", document.getElementById("f_tgl").value);
        data.append("estimasi", document.getElementById("f_estimasi").value.replace(/\D/g,''));
        data.append("tujuan", document.getElementById("f_tujuan").value.trim());
        data.append("session_nama", sessionStorage.getItem("nama") || "");
        data.append("kantor", kantor); // sudah benar, tinggal pastikan 'kantor' ada


        await fetch(urlGAS, {
            method: "POST",
            body: data,
            mode: "no-cors"
        });

        alert("Data berhasil disimpan ✅");
        closePopup();
        loadData();

    }catch(err){
        console.error(err);
        alert("Terjadi kesalahan koneksi!");
    }

    btn.disabled = false;
    btn.innerText = "Simpan";
}


function loadTujuan(){
    fetch(urlGAS + "?action=ref_sbm&kantor=" + encodeURIComponent(kantor))
    .then(res=>res.json())
    .then(data=>{
        const datalist=document.getElementById("listTujuan");
        datalist.innerHTML="";
        data.forEach(item=>{
            const option=document.createElement("option");
            option.value=item;
            datalist.appendChild(option);
        });
    });
}


document.addEventListener("DOMContentLoaded",()=>{
    loadTujuan();
});

  function formatEstimasi(input){

    // ambil angka saja
    let value = input.value.replace(/\D/g,'');

    // format ribuan
    input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    hitungStatusDana(); // langsung update status
}

 let detailDataGlobal = [];

async function lihatDetail(mak){
    showLoading();
    try{
        const response = await fetch(`${urlGAS}?action=detail&mak=${encodeURIComponent(mak)}&kantor=${encodeURIComponent(kantor)}`);
        const data = await response.json();
        detailDataGlobal = data;
        document.getElementById("detailTitle").innerText =
            "Detil kegiatan pada MAK " + mak;
        renderDetailTable(data);
        document.getElementById("popupDetail").style.display = "flex";
    }catch(err){
        console.error(err);
        alert("Gagal mengambil detail.");
    } finally { hideLoading(); }
}



function renderDetailTable(data){

    const body = document.getElementById("detailBody");
    body.innerHTML = "";

    data.forEach(d => {

        body.innerHTML += `
        <tr>
          <td>${d.uraian || ""}</td>

          <td>${d.pelaksana || ""}</td>

          <td>${d.tujuan || ""}</td>

          <td style="text-align:center;">
              ${formatDate(d.tgl_mulai)}
          </td>

          <td style="text-align:right;">
              ${Number(d.jumlah || 0).toLocaleString()}
          </td>


          <td style="text-align:center; ${getStatusStyle(d.status)}">
              ${d.status || ""}
          </td>
        </tr>
        `;
    });
}


function filterDetail(){

    const keyword = document.getElementById("searchDetail").value.toLowerCase();

    const filtered = detailDataGlobal.filter(d => {

        return (
            (d.uraian    || "").toString().toLowerCase().includes(keyword) ||
            (d.pelaksana || "").toString().toLowerCase().includes(keyword) ||
            (d.tujuan    || "").toString().toLowerCase().includes(keyword) ||
            (d.tgl_mulai || "").toString().toLowerCase().includes(keyword) ||
            (d.jumlah    || "").toString().toLowerCase().includes(keyword) ||
            (d.status    || "").toString().toLowerCase().includes(keyword)
        );

    });

    renderDetailTable(filtered);
}


function closeDetail(){
    document.getElementById("popupDetail").style.display = "none";
}

function showLoading(){
    const overlay = document.getElementById("loadingOverlay");
    overlay.style.display = "flex";
}

function hideLoading(){
    const overlay = document.getElementById("loadingOverlay");
    overlay.style.display = "none";
}
  
function autoRefresh(){
    fetch(urlGAS)
    .then(res => res.json())
    .then(data => {
        allData = data;
        applyFilter(); // refresh tapi tetap pakai filter aktif
    });
}

loadData();

setInterval(autoRefresh, 30000);

</script>

<!-- POPUP REKAM -->
<div id="popupRekam" class="popup-overlay">
  <div class="popup-box">
    <div class="popup-header">
      <h3>Rekam Kegiatan</h3>
      <span class="close-btn" onclick="closePopup()">✖</span>
    </div>

    <div class="popup-body">

      <div class="form-left">
        <label>ID Usulan</label>
        <input type="text" id="f_id" readonly>

        <label>No ST/ND / Uraian Kegiatan</label>
        <textarea id="f_uraian"></textarea>

        <label>Tgl ST/ND</label>
        <input type="date" id="f_tgl">

        <label>Estimasi Biaya</label>
        <input type="text" id="f_estimasi" oninput="formatEstimasi(this)">
        
        <label>Status Kecukupan Dana</label>
        <input type="text" id="f_sd_status" readonly>
        
        <label>Tujuan</label>
        <input type="text" id="f_tujuan" list="listTujuan">
        <datalist id="listTujuan"></datalist>

      </div>

      <div class="form-right">
        <label>MAK</label>
        <input type="text" id="f_mak" readonly>

        <label>Uraian MAK</label>
        <textarea id="f_uraian_mak" readonly></textarea>

        <label>Pagu</label>
        <input type="text" id="f_pagu" readonly>

        <label>Blokir</label>
        <input type="text" id="f_blokir" readonly>

        <label>Realisasi</label>
        <input type="text" id="f_realisasi" readonly>

        <label>Sisa</label>
        <input type="text" id="f_sisa" readonly>
      </div>

    </div>

    <div class="popup-footer">
      <button class="btn-simpan" onclick="simpanRekam()">Simpan</button>
    </div>
  </div>
</div>

<div id="popupDetail" class="popup-overlay" style="display:none;">
  <div class="popup-box" style="width:80%; max-width:900px;">
    
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="detailTitle"></h3>
      <button onclick="closeDetail()">✖</button>
    </div>

    <input type="text" id="searchDetail" 
           placeholder="Cari uraian / nomor ST..." 
           onkeyup="filterDetail()"
           style="width:100%; padding:8px; margin:10px 0;">

    <div style="max-height:400px; overflow:auto;">
      <table border="1" width="100%" style="border-collapse:collapse;">
        <thead>
          <tr>
            <th>Uraian/Nomor ST</th>
            <th>Pelaksana Tugas</th>
            <th>Tujuan</th>
            <th>Tgl Mulai</th>
            <th>Jumlah</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>

  </div>
</div>

<div id="loadingOverlay" style="
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.4);
    z-index:10000;
    justify-content:center;
    align-items:center;
">
    <div style="
        background:white;
        padding:20px 30px;
        border-radius:8px;
        font-size:16px;
        font-weight:600;
        display:flex;
        align-items:center;
        gap:10px;
    ">
        <i class="fa-solid fa-spinner fa-spin"></i> Memuat data...
    </div>
</div>

  
</body>
</html>











































