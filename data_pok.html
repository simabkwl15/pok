<body>
<div class="menu">
    <a href="pok.html">POK</a>
    <a href="kegiatan.html">Kegiatan</a>
</div>

<h2>POK</h2>

<p id="welcome"></p> <!-- <-- wajib ada -->

<div class="topbar">
    <div>
        <select id="cmbFilter">
            <option value="Semua">Semua</option>
            <option value="Umum">Umum</option>
            <option value="PKN">PKN</option>
            <option value="PN">PN</option>
            <option value="Penilaian">Penilaian</option>
            <option value="Lelang">Lelang</option>
            <option value="HI">HI</option>
            <option value="KI">KI</option>
        </select>

        <input type="text" id="txtCari" placeholder="Cari Kode / Uraian...">
    </div>

    <button onclick="downloadPDF()">Download PDF</button>
</div>

<div style="font-size:12px;color:#666;margin-bottom:6px;">
    Last update: <span id="lastUpdate">-</span>
</div>

<div id="areaPDF">
<table id="tblData">
    <thead></thead>
    <tbody></tbody>
</table>
</div>

<!-- SCRIPT di bawah supaya body sudah siap -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
window.addEventListener("DOMContentLoaded", () => {
    // SESSION & welcome
    const nama = sessionStorage.getItem("nama");
    const unit = sessionStorage.getItem("unit");
    if(!nama){
        window.location.href="/pok/index.html";
        return;
    } else {
        document.getElementById("welcome").textContent = `Selamat datang, ${nama} (${unit})`;
    }

    const BASE_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSi8QhfAg_PpNxxZ8XYaSF3g5ZB2rYJ4IwG8Zq3vHEGWvOLgsc21aO5V-18qOudsfJ-kkAxF_SyRbok/pub?gid=111618598&single=true&output=csv";
    let data = [];
    let col = {};

    const tblData = document.getElementById("tblData");
    const cmbFilter = document.getElementById("cmbFilter");
    const txtCari = document.getElementById("txtCari");
    const lastUpdate = document.getElementById("lastUpdate");

    function loadData() {
        Papa.parse(BASE_CSV + "&t=" + Date.now(), {
            download: true,
            skipEmptyLines: true,
            complete: res => {
                data = res.data;
                mapKolom();
                renderTable();
                lastUpdate.textContent = new Date().toLocaleTimeString();
            }
        });
    }

    cmbFilter.addEventListener("change", renderTable);
    txtCari.addEventListener("input", renderTable);

    function mapKolom() {
        col = {};
        data[0].forEach((h, i) => col[h.trim().toUpperCase()] = i);
    }

    function renderTable() {
        const thead = tblData.tHead || tblData.createTHead();
        const tbody = tblData.tBodies[0] || tblData.createTBody();
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if (data.length < 2) return;

        const idxKode = col["KODE"];
        const idxUraian = col["URAIAN"];
        const idxSD = col["SD"];
        const idxSeksi = col["SEKSI"];
        const idxVol = col["VOL"];
        const idxPagu = col["PAGU"];
        const idxBlokir = col["BLOKIR"];
        const idxRealisasi = col["REALISASI"];
        const idxSisa = col["SISA"];

        const filter = cmbFilter.value;
        const keyword = txtCari.value.toLowerCase();
        const uniqueKode = new Set();

        // HEADER
        const trh = document.createElement("tr");
        data[0].forEach((h, i) => {
            if (i === idxSeksi) return;
            const th = document.createElement("th");
            th.textContent = h;
            trh.appendChild(th);
        });
        thead.appendChild(trh);

        // DATA
        for (let i = 1; i < data.length; i++) {
            const r = data[i];
            const kode = r[idxKode]?.trim();
            const uraian = r[idxUraian]?.toLowerCase() || "";
            const sd = r[idxSD]?.trim().toUpperCase();
            const seksi = r[idxSeksi]?.trim();

            if (!kode) continue;
            if (filter !== "Semua" && seksi !== filter) continue;

            if (filter === "Semua") {
                if (uniqueKode.has(kode)) continue;
                uniqueKode.add(kode);
            }

            if (keyword && !kode.toLowerCase().includes(keyword) && !uraian.includes(keyword)) continue;

            const tr = document.createElement("tr");
            if (kode.length > 27 && sd === "RM") tr.className = "rm";
            if (kode.length > 27 && sd === "PNBP") tr.className = "pnbp";

            r.forEach((c, idx) => {
                if (idx === idxSeksi) return;
                const td = document.createElement("td");
                td.textContent = c ?? "";
                if (idx === idxVol) td.style.textAlign = "center";
                if ([idxPagu, idxBlokir, idxRealisasi, idxSisa].includes(idx)) td.style.textAlign = "right";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        }
    }

    function downloadPDF() {
        html2pdf()
            .set({margin:5, filename:'POK.pdf', html2canvas:{scale:2}, jsPDF:{orientation:'landscape'}})
            .from(document.getElementById("areaPDF"))
            .save();
    }

    window.downloadPDF = downloadPDF;

    loadData();
    setInterval(loadData, 60000);
});
</script>

